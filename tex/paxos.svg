<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.32.0 (20130827.0619)
 -->
<!-- Title: paxos Pages: 1 -->
<svg width="1332pt" height="912pt"
 viewBox="0.00 0.00 1332.00 912.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 908)">
<title>paxos</title>
<polygon fill="white" stroke="white" points="-4,5 -4,-908 1329,-908 1329,5 -4,5"/>
<!-- proposer -->
<g id="node1" class="node"><title>proposer</title>
<polygon fill="yellow" stroke="black" points="797,-904.401 655.96,-877 797,-849.599 938.04,-877 797,-904.401"/>
<text text-anchor="middle" x="797" y="-879.4" font-family="Times,serif" font-size="8.00">proposer &#160;id，值队列，</text>
<text text-anchor="middle" x="797" y="-869.8" font-family="Times,serif" font-size="8.00">准备状态实例队列，接受状态实例队列</text>
</g>
<!-- psend -->
<g id="node2" class="node"><title>psend</title>
<ellipse fill="yellow" stroke="black" cx="517" cy="-780" rx="34.0059" ry="34.0079"/>
<text text-anchor="middle" x="517" y="-777.6" font-family="Times,serif" font-size="8.00">发送缓冲区</text>
</g>
<!-- proposer&#45;&gt;psend -->
<g id="edge1" class="edge"><title>proposer&#45;&gt;psend</title>
<path fill="none" stroke="black" d="M747.264,-859.125C693.637,-840.93 609.205,-812.284 558.855,-795.201"/>
<polygon fill="black" stroke="black" points="559.853,-791.843 549.258,-791.945 557.604,-798.472 559.853,-791.843"/>
</g>
<!-- preceive -->
<g id="node5" class="node"><title>preceive</title>
<ellipse fill="yellow" stroke="black" cx="901" cy="-261" rx="33.3765" ry="33.8338"/>
<text text-anchor="middle" x="901" y="-258.6" font-family="Times,serif" font-size="8.00">接收缓冲区</text>
</g>
<!-- proposer&#45;&gt;preceive -->
<g id="edge2" class="edge"><title>proposer&#45;&gt;preceive</title>
<path fill="none" stroke="black" d="M816.562,-853.261C846.688,-815.829 901,-737.708 901,-661 901,-661 901,-661 901,-526 901,-448.174 901,-357.443 901,-305.166"/>
<polygon fill="black" stroke="black" points="904.5,-304.926 901,-294.926 897.5,-304.926 904.5,-304.926"/>
</g>
<!-- pprepare -->
<g id="node3" class="node"><title>pprepare</title>
<polygon fill="yellow" stroke="black" points="510.671,-641.6 510.671,-678.4 673.329,-678.4 673.329,-641.6 510.671,-641.6"/>
<text text-anchor="middle" x="592" y="-667.2" font-family="Times,serif" font-size="8.00">发送准备请求：一个发送消息队列，</text>
<text text-anchor="middle" x="592" y="-657.6" font-family="Times,serif" font-size="8.00">大小128，里面放满不同正在准备的实例，</text>
<text text-anchor="middle" x="592" y="-648" font-family="Times,serif" font-size="8.00">准备成功的实例会被动被取出。</text>
</g>
<!-- psend&#45;&gt;pprepare -->
<g id="edge3" class="edge"><title>psend&#45;&gt;pprepare</title>
<path fill="none" stroke="black" d="M534.964,-750.736C547.254,-731.4 563.428,-705.953 575.413,-687.098"/>
<polygon fill="black" stroke="black" points="578.514,-688.743 580.924,-678.426 572.606,-684.988 578.514,-688.743"/>
</g>
<!-- paccept -->
<g id="node4" class="node"><title>paccept</title>
<polygon fill="yellow" stroke="black" points="150.757,-636.8 150.757,-683.2 375.243,-683.2 375.243,-636.8 150.757,-636.8"/>
<text text-anchor="middle" x="263" y="-672" font-family="Times,serif" font-size="8.00">发送接受请求：如果一个实例准备成功</text>
<text text-anchor="middle" x="263" y="-662.4" font-family="Times,serif" font-size="8.00">，值队列有值，那么这个实例被加入到实例队列末尾并</text>
<text text-anchor="middle" x="263" y="-652.8" font-family="Times,serif" font-size="8.00">从值队列中取出一个，发送器</text>
<text text-anchor="middle" x="263" y="-643.2" font-family="Times,serif" font-size="8.00">从实例队列头部开始发送接收请求。</text>
</g>
<!-- psend&#45;&gt;paccept -->
<g id="edge4" class="edge"><title>psend&#45;&gt;paccept</title>
<path fill="none" stroke="black" d="M486.362,-764.766C445.371,-745.723 371.89,-711.587 320.438,-687.684"/>
<polygon fill="black" stroke="black" points="321.644,-684.385 311.1,-683.346 318.694,-690.733 321.644,-684.385"/>
</g>
<!-- arbf -->
<g id="node14" class="node"><title>arbf</title>
<ellipse fill="white" stroke="black" cx="443" cy="-660" rx="49.1672" ry="49.3893"/>
<text text-anchor="middle" x="443" y="-657.6" font-family="Times,serif" font-size="8.00">acceptor接收缓冲区</text>
</g>
<!-- psend&#45;&gt;arbf -->
<g id="edge18" class="edge"><title>psend&#45;&gt;arbf</title>
<path fill="none" stroke="black" d="M499.275,-750.736C491.839,-738.879 482.962,-724.724 474.481,-711.199"/>
<polygon fill="black" stroke="black" points="477.262,-709.046 468.984,-702.434 471.332,-712.765 477.262,-709.046"/>
</g>
<!-- prclient -->
<g id="node6" class="node"><title>prclient</title>
<polygon fill="yellow" stroke="black" points="814.354,-136 814.354,-172 987.646,-172 987.646,-136 814.354,-136"/>
<text text-anchor="middle" x="901" y="-156.4" font-family="Times,serif" font-size="8.00">客户端提交请求：将客户端提交的值加上大</text>
<text text-anchor="middle" x="901" y="-146.8" font-family="Times,serif" font-size="8.00">小类型等域放到值队列末尾。</text>
</g>
<!-- preceive&#45;&gt;prclient -->
<g id="edge5" class="edge"><title>preceive&#45;&gt;prclient</title>
<path fill="none" stroke="black" d="M901,-227.065C901,-212.734 901,-196.132 901,-182.478"/>
<polygon fill="black" stroke="black" points="904.5,-182.259 901,-172.259 897.5,-182.259 904.5,-182.259"/>
</g>
<!-- prprepare -->
<g id="node7" class="node"><title>prprepare</title>
<polygon fill="yellow" stroke="black" points="1005.85,-130.8 1005.85,-177.2 1324.15,-177.2 1324.15,-130.8 1005.85,-130.8"/>
<text text-anchor="middle" x="1165" y="-166" font-family="Times,serif" font-size="8.00">接收prepare请求的回复：从准备队列中找到相应实例，如果回复中的投票号很小，丢弃；</text>
<text text-anchor="middle" x="1165" y="-156.4" font-family="Times,serif" font-size="8.00">如果投票号相等，回复中带有值，</text>
<text text-anchor="middle" x="1165" y="-146.8" font-family="Times,serif" font-size="8.00">实例中保留最大的投票号对应的值，并将旧的值放入到proposer的值队列末尾。</text>
<text text-anchor="middle" x="1165" y="-137.2" font-family="Times,serif" font-size="8.00">如果回复的投票号更大，则用一个新的投票号发送准备请求。</text>
</g>
<!-- preceive&#45;&gt;prprepare -->
<g id="edge6" class="edge"><title>preceive&#45;&gt;prprepare</title>
<path fill="none" stroke="black" d="M931.801,-247.75C972.732,-231.47 1046.11,-202.286 1099.65,-180.991"/>
<polygon fill="black" stroke="black" points="1101.07,-184.193 1109.07,-177.245 1098.48,-177.689 1101.07,-184.193"/>
</g>
<!-- praccept -->
<g id="node8" class="node"><title>praccept</title>
<polygon fill="yellow" stroke="black" points="545.247,-130.8 545.247,-177.2 796.753,-177.2 796.753,-130.8 545.247,-130.8"/>
<text text-anchor="middle" x="671" y="-166" font-family="Times,serif" font-size="8.00">接收accept请求的回复：从实例队列中找到相应实例，</text>
<text text-anchor="middle" x="671" y="-156.4" font-family="Times,serif" font-size="8.00">比较投票的值，统计收到的回复数量，达到多数派，</text>
<text text-anchor="middle" x="671" y="-146.8" font-family="Times,serif" font-size="8.00">那么从实例队列中将此实例移除。如果收到的回复不是当前的投票号，</text>
<text text-anchor="middle" x="671" y="-137.2" font-family="Times,serif" font-size="8.00">将此实例从接受队列移除放入到准备队列头部重新发送准备请求。</text>
</g>
<!-- preceive&#45;&gt;praccept -->
<g id="edge7" class="edge"><title>preceive&#45;&gt;praccept</title>
<path fill="none" stroke="black" d="M870.458,-246.057C834.522,-229.651 774.064,-202.051 729.11,-181.529"/>
<polygon fill="black" stroke="black" points="730.318,-178.232 719.767,-177.263 727.411,-184.6 730.318,-178.232"/>
</g>
<!-- acceptor -->
<g id="node9" class="node"><title>acceptor</title>
<polygon fill="white" stroke="black" points="443,-573.3 338.641,-527 443,-480.7 547.359,-527 443,-573.3"/>
<text text-anchor="middle" x="443" y="-539" font-family="Times,serif" font-size="8.00">acceptor将所有请求存</text>
<text text-anchor="middle" x="443" y="-529.4" font-family="Times,serif" font-size="8.00">储在bdb数据库中，</text>
<text text-anchor="middle" x="443" y="-519.8" font-family="Times,serif" font-size="8.00">事物读写，以请求的实</text>
<text text-anchor="middle" x="443" y="-510.2" font-family="Times,serif" font-size="8.00">例号作为key.</text>
</g>
<!-- aprepare -->
<g id="node10" class="node"><title>aprepare</title>
<polygon fill="white" stroke="black" points="223.919,-356.4 223.919,-431.6 456.081,-431.6 456.081,-356.4 223.919,-356.4"/>
<text text-anchor="middle" x="340" y="-420.4" font-family="Times,serif" font-size="8.00">处理准备请求：数据库中查找是</text>
<text text-anchor="middle" x="340" y="-410.8" font-family="Times,serif" font-size="8.00">否已经存在过相应请求的记录，</text>
<text text-anchor="middle" x="340" y="-401.2" font-family="Times,serif" font-size="8.00">如果当前请求的投票号小于数据库中的，丢弃；</text>
<text text-anchor="middle" x="340" y="-391.6" font-family="Times,serif" font-size="8.00">如果数据库中记录显示该请求已经获得最终值，丢弃；</text>
<text text-anchor="middle" x="340" y="-382" font-family="Times,serif" font-size="8.00">如果数据库中不存在，将该请求保存。每个记录的字段：</text>
<text text-anchor="middle" x="340" y="-372.4" font-family="Times,serif" font-size="8.00">acceptor_id,iid_t iid,投票号，有值的投票号，</text>
<text text-anchor="middle" x="340" y="-362.8" font-family="Times,serif" font-size="8.00">是否是最终值，值大小，值域。</text>
</g>
<!-- acceptor&#45;&gt;aprepare -->
<g id="edge8" class="edge"><title>acceptor&#45;&gt;aprepare</title>
<path fill="none" stroke="black" d="M416.475,-492.264C403.976,-476.368 388.888,-457.178 375.428,-440.059"/>
<polygon fill="black" stroke="black" points="377.902,-437.543 368.97,-431.845 372.399,-441.869 377.902,-437.543"/>
</g>
<!-- aaccept -->
<g id="node11" class="node"><title>aaccept</title>
<polygon fill="white" stroke="black" points="473.886,-376 473.886,-412 694.114,-412 694.114,-376 473.886,-376"/>
<text text-anchor="middle" x="584" y="-396.4" font-family="Times,serif" font-size="8.00">处理接受请求：从数据库中查找相应请求的记录，</text>
<text text-anchor="middle" x="584" y="-386.8" font-family="Times,serif" font-size="8.00">如果投票号太久，丢弃；否则存储当前请求到数据库中。</text>
</g>
<!-- acceptor&#45;&gt;aaccept -->
<g id="edge9" class="edge"><title>acceptor&#45;&gt;aaccept</title>
<path fill="none" stroke="black" d="M476.058,-495.286C501.069,-472.05 534.936,-440.584 558.022,-419.136"/>
<polygon fill="black" stroke="black" points="560.465,-421.643 565.409,-412.272 555.701,-416.515 560.465,-421.643"/>
</g>
<!-- arepeat -->
<g id="node12" class="node"><title>arepeat</title>
<polygon fill="white" stroke="black" points="712.531,-375.6 712.531,-412.4 873.469,-412.4 873.469,-375.6 712.531,-375.6"/>
<text text-anchor="middle" x="793" y="-401.2" font-family="Times,serif" font-size="8.00">处理重复请求：来自learner，</text>
<text text-anchor="middle" x="793" y="-391.6" font-family="Times,serif" font-size="8.00">从数据库中取出相应请求并返回，</text>
<text text-anchor="middle" x="793" y="-382" font-family="Times,serif" font-size="8.00">如果记录不为空，再发送一次accept回复。</text>
</g>
<!-- acceptor&#45;&gt;arepeat -->
<g id="edge10" class="edge"><title>acceptor&#45;&gt;arepeat</title>
<path fill="none" stroke="black" d="M507.82,-509.314C561.19,-494.69 638.318,-471.503 703,-444 720.655,-436.493 739.406,-426.616 755.196,-417.698"/>
<polygon fill="black" stroke="black" points="757.185,-420.592 764.121,-412.583 753.704,-414.519 757.185,-420.592"/>
</g>
<!-- asbf -->
<g id="node13" class="node"><title>asbf</title>
<ellipse fill="white" stroke="black" cx="156" cy="-394" rx="49.2974" ry="49.5635"/>
<text text-anchor="middle" x="156" y="-391.6" font-family="Times,serif" font-size="8.00">acceptor发送缓冲区</text>
</g>
<!-- acceptor&#45;&gt;asbf -->
<g id="edge12" class="edge"><title>acceptor&#45;&gt;asbf</title>
<path fill="none" stroke="black" d="M377.983,-509.186C330.887,-495.47 266.68,-473.532 215,-444 209.964,-441.122 204.933,-437.805 200.052,-434.281"/>
<polygon fill="black" stroke="black" points="202.092,-431.435 192.004,-428.197 197.871,-437.019 202.092,-431.435"/>
</g>
<!-- asbf&#45;&gt;preceive -->
<g id="edge19" class="edge"><title>asbf&#45;&gt;preceive</title>
<path fill="none" stroke="black" d="M190.941,-358.569C198.383,-352.861 206.56,-347.629 215,-344 331.676,-293.84 724.732,-270.555 857.083,-264.006"/>
<polygon fill="black" stroke="black" points="857.434,-267.493 867.251,-263.51 857.093,-260.501 857.434,-267.493"/>
</g>
<!-- lrbf -->
<g id="node19" class="node"><title>lrbf</title>
<ellipse fill="green" stroke="black" cx="173" cy="-261" rx="46.4639" ry="46.7864"/>
<text text-anchor="middle" x="173" y="-258.6" font-family="Times,serif" font-size="8.00">learner接收缓冲区</text>
</g>
<!-- asbf&#45;&gt;lrbf -->
<g id="edge20" class="edge"><title>asbf&#45;&gt;lrbf</title>
<path fill="none" stroke="black" d="M162.282,-344.593C163.423,-335.802 164.621,-326.57 165.786,-317.592"/>
<polygon fill="black" stroke="black" points="169.266,-317.968 167.082,-307.601 162.324,-317.067 169.266,-317.968"/>
</g>
<!-- arbf&#45;&gt;acceptor -->
<g id="edge11" class="edge"><title>arbf&#45;&gt;acceptor</title>
<path fill="none" stroke="black" d="M443,-610.22C443,-601.541 443,-592.442 443,-583.59"/>
<polygon fill="black" stroke="black" points="446.5,-583.352 443,-573.352 439.5,-583.352 446.5,-583.352"/>
</g>
<!-- learner -->
<g id="node15" class="node"><title>learner</title>
<polygon fill="green" stroke="black" points="190,-172 71.9838,-154 190,-136 308.016,-154 190,-172"/>
<text text-anchor="middle" x="190" y="-151.6" font-family="Times,serif" font-size="8.00">learner有一个实例队列保存接收到的实例</text>
</g>
<!-- laccept -->
<g id="node16" class="node"><title>laccept</title>
<polygon fill="green" stroke="black" points="284.35,-14.2 284.35,-79.8 533.65,-79.8 533.65,-14.2 284.35,-14.2"/>
<text text-anchor="middle" x="409" y="-68.6" font-family="Times,serif" font-size="8.00">处理acceptor发来的accept回复，</text>
<text text-anchor="middle" x="409" y="-59" font-family="Times,serif" font-size="8.00">更新相应状态确定该实例是否关闭。</text>
<text text-anchor="middle" x="409" y="-49.4" font-family="Times,serif" font-size="8.00">如果实例已经关闭，丢弃；如果实例太超前，还有很多实例未处理</text>
<text text-anchor="middle" x="409" y="-39.8" font-family="Times,serif" font-size="8.00">，丢弃；更新相关实例，统计是否已经达到多数派，</text>
<text text-anchor="middle" x="409" y="-30.2" font-family="Times,serif" font-size="8.00">达到就丢弃请求当前请求，并且实例保存最终值；</text>
<text text-anchor="middle" x="409" y="-20.6" font-family="Times,serif" font-size="8.00">保存更新的提案回复到相应acceptor对应的回复队列中。</text>
</g>
<!-- learner&#45;&gt;laccept -->
<g id="edge15" class="edge"><title>learner&#45;&gt;laccept</title>
<path fill="none" stroke="black" d="M217.294,-139.914C246.121,-126.092 292.863,-103.682 332.975,-84.4505"/>
<polygon fill="black" stroke="black" points="334.712,-87.4992 342.216,-80.0198 331.685,-81.1872 334.712,-87.4992"/>
</g>
<!-- lcheck -->
<g id="node17" class="node"><title>lcheck</title>
<polygon fill="green" stroke="black" points="112.106,-29 112.106,-65 265.894,-65 265.894,-29 112.106,-29"/>
<text text-anchor="middle" x="189" y="-49.4" font-family="Times,serif" font-size="8.00">检查空洞，对没有完成的</text>
<text text-anchor="middle" x="189" y="-39.8" font-family="Times,serif" font-size="8.00">实例重新发送请求，获取accept的回复。</text>
</g>
<!-- learner&#45;&gt;lcheck -->
<g id="edge16" class="edge"><title>learner&#45;&gt;lcheck</title>
<path fill="none" stroke="black" d="M189.835,-135.661C189.678,-119.225 189.441,-94.2776 189.259,-75.1941"/>
<polygon fill="black" stroke="black" points="192.757,-74.9822 189.162,-65.016 185.758,-75.0489 192.757,-74.9822"/>
</g>
<!-- lsbf -->
<g id="node18" class="node"><title>lsbf</title>
<ellipse fill="green" stroke="black" cx="46" cy="-47" rx="46.5944" ry="46.9613"/>
<text text-anchor="middle" x="46" y="-44.6" font-family="Times,serif" font-size="8.00">learner发送缓冲区</text>
</g>
<!-- learner&#45;&gt;lsbf -->
<g id="edge13" class="edge"><title>learner&#45;&gt;lsbf</title>
<path fill="none" stroke="black" d="M168.561,-139.176C150.739,-127.515 124.852,-110.184 103,-94 98.5931,-90.7362 94.0534,-87.2666 89.5507,-83.7533"/>
<polygon fill="black" stroke="black" points="91.5405,-80.865 81.5225,-77.4169 87.2037,-86.3597 91.5405,-80.865"/>
</g>
<!-- lsbf&#45;&gt;arbf -->
<g id="edge21" class="edge"><title>lsbf&#45;&gt;arbf</title>
<path fill="none" stroke="black" d="M45.3173,-93.9026C44.7379,-136.842 44,-202.765 44,-260 44,-395 44,-395 44,-395 44,-573.789 237.326,-507.764 384,-610 388.758,-613.317 393.606,-616.924 398.374,-620.626"/>
<polygon fill="black" stroke="black" points="396.286,-623.437 406.295,-626.912 400.638,-617.954 396.286,-623.437"/>
</g>
<!-- lrbf&#45;&gt;learner -->
<g id="edge14" class="edge"><title>lrbf&#45;&gt;learner</title>
<path fill="none" stroke="black" d="M180.308,-214.861C182.132,-203.595 184.031,-191.868 185.659,-181.81"/>
<polygon fill="black" stroke="black" points="189.161,-182.083 187.304,-171.652 182.251,-180.964 189.161,-182.083"/>
</g>
<!-- client -->
<g id="node20" class="node"><title>client</title>
<polygon fill="red" stroke="black" points="956,-412 928.936,-394 956,-376 983.064,-394 956,-412"/>
<text text-anchor="middle" x="956" y="-391.6" font-family="Times,serif" font-size="8.00">client</text>
</g>
<!-- client&#45;&gt;preceive -->
<g id="edge17" class="edge"><title>client&#45;&gt;preceive</title>
<path fill="none" stroke="black" d="M950.321,-379.474C942.695,-361.309 928.819,-328.259 917.723,-301.832"/>
<polygon fill="black" stroke="black" points="920.876,-300.3 913.778,-292.435 914.422,-303.01 920.876,-300.3"/>
</g>
</g>
</svg>
